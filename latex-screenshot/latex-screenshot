#!/bin/bash

# --- CONFIGURATION ---
# Path to the specific Python inside pipx (Ensure this path exists!)
DAEMON_PYTHON="$HOME/.local/share/pipx/venvs/pix2text/bin/python"
DAEMON_SCRIPT="$HOME/.local/bin/latexocrd.py"
PIPE_PATH="/tmp/pix2text_pipe"
TMP_IMG="/tmp/latex_ocr_snip.png"

# --- EXECUTION ---

# 1. Take Screenshot (Fast, X11)
maim -s -u -b 3 -c 0.3,0.3,0.3,0.5 "$TMP_IMG"

if [ ! -s "$TMP_IMG" ]; then
    rm -f "$TMP_IMG" # Clean up if empty
    exit 0
fi

# If user cancelled (no file), exit
if [ ! -f "$TMP_IMG" ]; then
    exit 0
fi

# 2. Ensure Daemon is Running
if ! pgrep -f "latexocrd.py" > /dev/null; then
    # Start it in background
    notify-send "LaTeX OCR" "Starting engine..." -t 1000 -h int:transient:1
    nohup "$DAEMON_PYTHON" "$DAEMON_SCRIPT" > /dev/null 2>&1 &
    
    # Wait for the pipe to appear (Max 10 seconds)
    TIMEOUT=0
    while [ ! -p "$PIPE_PATH" ]; do
        sleep 0.5
        ((TIMEOUT++))
        if [ $TIMEOUT -ge 20 ]; then
            notify-send "LaTeX OCR" "Error: Daemon failed to start." -u critical -t 1000
            exit 1
        fi
    done
fi

# 3. Send Job to Daemon
# We just write the filename to the pipe. The python script picks it up instantly.
echo "$TMP_IMG" > "$PIPE_PATH"

exit 0
